L.Control.Elevation=L.Control.extend({options:{autohide:true,autohidePositionMarker:true,collapsed:false,controlButton:{iconCssClass:"elevation-toggle-icon",title:"Elevation"},detachedView:false,distanceFactor:1,elevationDiv:"#elevation-div",followPositionMarker:false,forceAxisBounds:false,gpxOptions:{async:true,marker_options:{startIconUrl:null,endIconUrl:null,shadowUrl:null,},polyline_options:{className:"",color:"#566B13",opacity:0.75,weight:5,lineCap:"round"},},height:175,heightFactor:1,hoverNumber:{decimalsX:2,decimalsY:0,formatter:undefined},imperial:false,interpolation:d3.curveLinear,position:"topright",theme:"lime-theme",margins:{top:10,right:20,bottom:30,left:50},responsiveView:true,useHeightIndicator:true,useLeafletMarker:false,useMapIndicator:true,width:600,xLabel:"km",xTicks:undefined,yAxisMax:undefined,yAxisMin:undefined,yLabel:"m",yTicks:undefined,zFollow:13,},__mileFactor:0.621371,__footFactor:3.28084,addData:function(b,a){this._addData(b);if(this._container){this._applyData()}if((typeof a==="undefined"||a===null)&&b.on){a=b}if(a){if(a._path){L.DomUtil.addClass(a._path,"elevation-polyline "+this.options.theme)}a.on("mousemove",this._mousemoveLayerHandler,this).on("mouseout",this._mouseoutHandler,this)}this.track_info=this.track_info||{};this.track_info.distance=this._distance;this.track_info.elevation_max=this._maxElevation;this.track_info.elevation_min=this._minElevation;this._layers=this._layers||{};this._layers[L.Util.stamp(a)]=a;this._map.fireEvent("eledata_added",{data:b,layer:a,track_info:this.track_info,},true)},addTo:function(a){if(this.options.detachedView){this._addToChartDiv(a)}else{L.Control.prototype.addTo.call(this,a)}},clear:function(){this._clearPath();this._clearChart();this._clearData();if(this._map){this._map.fireEvent("eledata_clear")}},disableDragging:function(){this._draggingEnabled=false;this._resetDrag()},enableDragging:function(){this._draggingEnabled=true},fitBounds:function(){this._map.fitBounds(this._fullExtent)},getZFollow:function(){return this._zFollow},hide:function(){this._container.style.display="none"},loadChart:function(a){this.addTo(a)},loadData:function(a){if(this._isXMLDoc(a)){this.loadGPX(a)}else{if(this._isJSONDoc(a)){this.loadGeoJSON(a)}else{this.loadFile(a)}}},loadFile:function(a){try{var c=new XMLHttpRequest();c.responseType="text";c.open("GET",a);c.onload=function(){if(c.status!==200){throw"Error "+c.status+" while fetching remote file: "+a}else{this.loadData(c.response)}}.bind(this);c.send()}catch(b){console.warn(b)}},loadGeoJSON:function(a){if(typeof a==="string"){a=JSON.parse(a)}this.layer=this.geojson=L.geoJson(a,{style:function(b){return{color:"#566B13",className:"elevation-polyline "+this.options.theme,}}.bind(this),onEachFeature:function(c,b){this.addData(c,b);this.track_info=this.track_info||{};this.track_info.type="geojson";this.track_info.name=a.name;this.track_info.distance=this._distance;this.track_info.elevation_max=this._maxElevation;this.track_info.elevation_min=this._minElevation}.bind(this),});this._map.once("layeradd",function(b){this._map.fitBounds(this.layer.getBounds());this._map.fireEvent("eledata_loaded",{data:a,layer:this.layer,name:this.track_info.name,track_info:this.track_info,},true)},this);this.layer.addTo(this._map)},loadGPX:function(a){this.options.gpxOptions.polyline_options.className+="elevation-polyline "+this.options.theme;this.layer=this.gpx=new L.GPX(a,this.options.gpxOptions);this.layer.on("loaded",function(b){this._map.fitBounds(b.target.getBounds())},this);this.layer.once("addline",function(b){this.addData(b.line);this.track_info=this.track_info||{};this.track_info.type="gpx";this.track_info.name=this.layer.get_name();this.track_info.distance=this._distance;this.track_info.elevation_max=this._maxElevation;this.track_info.elevation_min=this._minElevation;this._map.fireEvent("eledata_loaded",{data:a,layer:this.layer,name:this.track_info.name,track_info:this.track_info,},true)},this);this.layer.addTo(this._map)},initialize:function(a){this.options.autohide=typeof a.autohide!=="undefined"?a.autohide:!L.Browser.mobile;L.Util.setOptions(this,a);this._draggingEnabled=!L.Browser.mobile;if(a.imperial){this._distanceFactor=this.__mileFactor;this._heightFactor=this.__footFactor;this._xLabel="mi";this._yLabel="ft"}else{this._distanceFactor=this.options.distanceFactor;this._heightFactor=this.options.heightFactor;this._xLabel=this.options.xLabel;this._yLabel=this.options.yLabel}this._zFollow=this.options.zFollow},onAdd:function(c){this._map=c;var b=this.options;var a=this._container=L.DomUtil.create("div","elevation");L.DomUtil.addClass(a,"leaflet-control "+b.theme);this._initToggle(a);this._initChart(a);this._applyData();this._map.on("zoom viewreset zoomanim",this._hidePositionMarker,this);this._map.on("resize",this._resetView,this);this._map.on("resize",this._resizeChart,this);this._map.on("mousedown",this._resetDrag,this);L.DomEvent.on(this._map._container,"mousewheel",this._resetDrag,this);L.DomEvent.on(this._map._container,"touchstart",this._resetDrag,this);return a},onRemove:function(a){this._container=null},setZFollow:function(a){this._zFollow=a},show:function(){this._container.style.display="block"},_addData:function(e){var b=e&&e.geometry&&e.geometry;var a;if(b){switch(b.type){case"LineString":this._addGeoJSONData(b.coordinates);break;case"MultiLineString":for(a=0;a<b.coordinates.length;a++){this._addGeoJSONData(b.coordinates[a])}break;default:console.warn("Unsopperted GeoJSON feature geometry type:"+b.type)}}var c=e&&e.type==="FeatureCollection";if(c){for(a=0;a<e.features.length;a++){this._addData(e.features[a])}}if(e&&e._latlngs){this._addGPXdata(e._latlngs)}},_addGeoJSONData:function(b){if(b){for(var a=0;a<b.length;a++){this._addPoint(b[a][1],b[a][0],b[a][2])}}},_addGPXdata:function(b){if(b){for(var a=0;a<b.length;a++){this._addPoint(b[a].lat,b[a].lng,b[a].meta.ele)}}},_addPoint:function(i,h,e){var a=this.options;var d=this._data||[];var b=this._maxElevation||-Infinity;var g=this._minElevation||+Infinity;var f=this._distance||0;var k=new L.LatLng(i,h);var c=d.length?d[d.length-1].latlng:k;var j=k.distanceTo(c)*this._distanceFactor;f=f+Math.round(j/1000*100000)/100000;if(typeof e!=="undefined"){e=e*this._heightFactor;b=b<e?e:b;g=g>e?e:g;d.push({dist:f,x:i,y:h,z:e,latlng:k})}this._data=d;this._distance=f;this._maxElevation=b;this._minElevation=g},_addToChartDiv:function(b){var a=this.onAdd(b);var c=document.querySelector(this.options.elevationDiv);c.appendChild(a)},_appendChart:function(a){var b=a.append("g").attr("transform","translate("+this.options.margins.left+","+this.options.margins.top+")");this._appendGrid(b);this._appendAreaPath(b);this._appendAxis(b);this._appendFocusRect(b);this._appendMouseFocusG(b)},_appendXaxis:function(a){a.append("g").attr("class","x axis").attr("transform","translate(0,"+this._height()+")").call(d3.axisBottom().scale(this._x).ticks(this.options.xTicks)).append("text").attr("x",this._width()+6).attr("y",30).text(this._xLabel)},_appendXGrid:function(a){a.append("g").attr("class","x grid").attr("transform","translate(0,"+this._height()+")").call(d3.axisBottom().scale(this._x).ticks(this.options.xTicks).tickSize(-this._height()).tickFormat(""))},_appendYaxis:function(a){a.append("g").attr("class","y axis").call(d3.axisLeft().scale(this._y).ticks(this.options.yTicks)).append("text").attr("x",-30).attr("y",3).text(this._yLabel)},_appendYGrid:function(a){a.append("g").attr("class","y grid").call(d3.axisLeft().scale(this._y).ticks(this.options.yTicks).tickSize(-this._width()).tickFormat(""))},_appendAreaPath:function(a){this._areapath=a.append("path").attr("class","area")},_appendAxis:function(a){this._axis=a.append("g").attr("class","axis");this._appendXaxis(this._axis);this._appendYaxis(this._axis)},_appendFocusRect:function(a){var b=this._focusRect=a.append("rect").attr("width",this._width()).attr("height",this._height()).style("fill","none").style("stroke","none").style("pointer-events","all");if(L.Browser.mobile){b.on("touchmove.drag",this._dragHandler.bind(this)).on("touchstart.drag",this._dragStartHandler.bind(this)).on("touchstart.focus",this._mousemoveHandler.bind(this)).on("touchmove.focus",this._mousemoveHandler.bind(this));L.DomEvent.on(this._container,"touchend",this._dragEndHandler,this)}b.on("mousemove.drag",this._dragHandler.bind(this)).on("mousedown.drag",this._dragStartHandler.bind(this)).on("mousemove.focus",this._mousemoveHandler.bind(this)).on("mouseout.focus",this._mouseoutHandler.bind(this));L.DomEvent.on(this._container,"mouseup",this._dragEndHandler,this)},_appendGrid:function(a){this._grid=a.append("g").attr("class","grid");this._appendXGrid(this._grid);this._appendYGrid(this._grid)},_appendMouseFocusG:function(b){var a=this._focusG=b.append("g").attr("class","mouse-focus-group");this._mousefocus=a.append("svg:line").attr("class","mouse-focus-line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0");this._focuslabelrect=a.append("rect").attr("class","mouse-focus-label").attr("x",0).attr("y",0).attr("width",0).attr("height",0).attr("rx",3).attr("ry",3);this._focuslabeltext=a.append("svg:text").attr("class","mouse-focus-label-text");this._focuslabelY=this._focuslabeltext.append("svg:tspan").attr("class","mouse-focus-label-y").attr("dy","-1em");this._focuslabelX=this._focuslabeltext.append("svg:tspan").attr("class","mouse-focus-label-x").attr("dy","2em")},_appendPositionMarker:function(c){var b=this.options.theme;var a=c.append("g");this._mouseHeightFocus=a.append("svg:line").attr("class",b+" height-focus line").attr("x2",0).attr("y2",0).attr("x1",0).attr("y1",0);this._pointG=a.append("g");this._pointG.append("svg:circle").attr("class",b+" height-focus circle-lower").attr("r",6).attr("cx",0).attr("cy",0);this._mouseHeightFocusLabel=a.append("svg:text").attr("class",b+" height-focus-label").style("pointer-events","none")},_applyData:function(){if(!this._data){return}var a=d3.extent(this._data,function(e){return e.dist});var c=d3.extent(this._data,function(e){return e.z});var b=this.options;if(b.yAxisMin!==undefined&&(b.yAxisMin<c[0]||b.forceAxisBounds)){c[0]=b.yAxisMin}if(b.yAxisMax!==undefined&&(b.yAxisMax>c[1]||b.forceAxisBounds)){c[1]=b.yAxisMax}this._x.domain(a);this._y.domain(c);this._areapath.datum(this._data).attr("d",this._area);this._updateAxis();this._fullExtent=this._calculateFullExtent(this._data)},_calculateFullExtent:function(b){if(!b||b.length<1){throw new Error("no data in parameters")}var a=new L.latLngBounds(b[0].latlng,b[0].latlng);b.forEach(function(c){a.extend(c.latlng)});return a},_clearChart:function(){this._resetDrag();if(this._areapath){this._areapath.attr("d","M0 0");this._x.domain([0,1]);this._y.domain([0,1]);this._updateAxis()}},_clearData:function(){this._data=null;this._distance=null;this._maxElevation=null;this._minElevation=null;this.track_info=null;this._layers=null},_clearPath:function(){this._hidePositionMarker();for(var a in this._layers){L.DomUtil.removeClass(this._layers[a]._path,"elevation-polyline");L.DomUtil.removeClass(this._layers[a]._path,this.options.theme)}},_collapse:function(){if(this._container){L.DomUtil.removeClass(this._container,"elevation-expanded");L.DomUtil.addClass(this._container,"elevation-collapsed")}},_dragHandler:function(){d3.event.preventDefault();d3.event.stopPropagation();this._gotDragged=true;this._drawDragRectangle()},_dragEndHandler:function(){if(!this._dragStartCoords||!this._dragCurrentCoords||!this._gotDragged){this._dragStartCoords=null;this._gotDragged=false;if(this._draggingEnabled){this._resetDrag()}return}var b=this._findItemForX(this._dragStartCoords[0]),a=this._findItemForX(this._dragCurrentCoords[0]);if(b==a){return}this._hidePositionMarker();this._fitSection(b,a);this._dragStartCoords=null;this._gotDragged=false;this._map.fireEvent("elechart_dragged",{data:{dragstart:this._data[b],dragend:this._data[a]}},true)},_dragStartHandler:function(){d3.event.preventDefault();d3.event.stopPropagation();this._gotDragged=false;this._dragStartCoords=d3.mouse(this._focusRect.node())},_drawDragRectangle:function(){if(!this._dragStartCoords||!this._draggingEnabled){return}var a=this._dragCurrentCoords=d3.mouse(this._focusRect.node());var c=Math.min(this._dragStartCoords[0],a[0]),b=Math.max(this._dragStartCoords[0],a[0]);if(!this._dragRectangle&&!this._dragRectangleG){var d=d3.select(this._container).select("svg").select("g");this._dragRectangleG=d.insert("g",".mouse-focus-group");this._dragRectangle=this._dragRectangleG.append("rect").attr("width",b-c).attr("height",this._height()).attr("x",c).attr("class","mouse-drag").style("pointer-events","none")}else{this._dragRectangle.attr("width",b-c).attr("x",c)}},_expand:function(){if(this._container){L.DomUtil.removeClass(this._container,"elevation-collapsed");L.DomUtil.addClass(this._container,"elevation-expanded")}},_findItemForLatLng:function(c){var a=null,b=Infinity;this._data.forEach(function(d){var e=c.distanceTo(d.latlng);if(e<b){b=e;a=d}});return a},_findItemForX:function(a){var c=d3.bisector(function(e){return e.dist}).left;var b=this._x.invert(a);return c(this._data,b)},_fitSection:function(e,c){var d=Math.min(e,c),a=Math.max(e,c);var b=this._calculateFullExtent(this._data.slice(d,a));this._map.fitBounds(b)},_formatter:function(c,g,b){var e;if(g===0){e=Math.round(c)+""}else{e=L.Util.formatNum(c,g)+""}var a=e.split(".");if(a[1]){var f=g-a[1].length;for(;f>0;f--){a[1]+="0"}e=a.join(b||".")}return e},_height:function(){var a=this.options;return a.height-a.margins.top-a.margins.bottom},_hidePositionMarker:function(){if(!this.options.autohidePositionMarker){return}this._selectedItem=null;if(this._marker){this._map.removeLayer(this._marker);this._marker=null}if(this._mouseHeightFocus){this._mouseHeightFocus.style("visibility","hidden");this._mouseHeightFocusLabel.style("visibility","hidden")}if(this._pointG){this._pointG.style("visibility","hidden")}this._focusG.style("visibility","hidden")},_initChart:function(){var a=this.options;a.xTicks=a.xTicks||Math.round(this._width()/75);a.yTicks=a.yTicks||Math.round(this._height()/30);a.hoverNumber.formatter=a.hoverNumber.formatter||this._formatter;if(a.responsiveView){if(a.detachedView){var f=document.querySelector(a.elevationDiv).offsetWidth;var c=document.querySelector(a.elevationDiv).offsetHeight;a.width=f>0?f:a.width;a.height=(c-20)>0?c-20:a.height-20}else{a._maxWidth=a._maxWidth>a.width?a._maxWidth:a.width;var h=this._map._container.clientWidth;a.width=a._maxWidth>h?h-30:a.width}}var i=this._x=d3.scaleLinear().range([0,this._width()]);var g=this._y=d3.scaleLinear().range([this._height(),0]);var d=this._area=d3.area().curve(a.interpolation).x(function(l){return(l.xDiagCoord=i(l.dist))}).y0(this._height()).y1(function(l){return g(l.z)});var k=this._line=d3.line().x(function(l){return d3.mouse(e.select("g"))[0]}).y(function(l){return this._height()});var b=this._container;var j=d3.select(b).attr("width",a.width);var e=j.append("svg").attr("class","background").attr("width",a.width).attr("height",a.height);this._appendChart(e)},_initToggle:function(a){a.setAttribute("aria-haspopup",true);if(!this.options.detachedView){L.DomEvent.disableClickPropagation(a)}if(L.Browser.mobile){L.DomEvent.on(a,"click",L.DomEvent.stopPropagation)}L.DomEvent.on(a,"mousewheel",this._mousewheelHandler,this);if(!this.options.detachedView){var c="elevation-toggle "+this.options.controlButton.iconCssClass+(this.options.autohide?"":" close-button");var b=this._button=L.DomUtil.create("a",c,a);b.href="#";b.title=this.options.controlButton.title;if(this.options.collapsed){this._collapse();if(this.options.autohide){L.DomEvent.on(a,"mouseover",this._expand,this).on(a,"mouseout",this._collapse,this)}else{L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",this._toggle,this)}L.DomEvent.on(b,"focus",this._toggle,this);this._map.on("click",this._collapse,this)}}else{}},_isJSONDoc:function(c,a){a=typeof a==="undefined"?true:a;if(typeof c==="string"&&a){c=c.trim();return c.indexOf("{")==0||c.indexOf("[")==0}else{try{c=c.toString();JSON.parse(c)}catch(b){console.warn(b);return false}return true}},_isXMLDoc:function(c,a){a=typeof a==="undefined"?true:a;if(typeof c==="string"&&a){c=c.trim();return c.indexOf("<")==0}else{var b=(c?c.ownerDocument||c:0).documentElement;return b?b.nodeName!=="HTML":false}},_isDomVisible:function(a){return !!(a.offsetWidth||a.offsetHeight||a.getClientRects().length)},_mousemoveHandler:function(h,b,a){if(!this._data||this._data.length===0){return}var f=d3.mouse(this._focusRect.node());var g=f[0];var e=this._data[this._findItemForX(g)];this._hidePositionMarker();this._showDiagramIndicator(e,g);this._showPositionMarker(e);if(this.options.followPositionMarker){var c=this._map.getZoom();c=c<this._zFollow?this._zFollow:c;this._map.setView(e.latlng,c)}this._map.fireEvent("elechart_change",{data:e},true)},_mousemoveLayerHandler:function(c){if(!this._data||this._data.length===0){return}var d=c.latlng;var b=this._findItemForLatLng(d);if(b){var a=b.xDiagCoord;this._hidePositionMarker();this._showDiagramIndicator(b,a);this._showPositionMarker(b)}},_mouseoutHandler:function(){if(!this.options.detachedView){this._hidePositionMarker()}},_mousewheelHandler:function(b){var a=this._selectedItem?this._selectedItem.latlng:this._map.getCenter();var c=b.deltaY>0?this._map.getZoom()-1:this._map.getZoom()+1;this._resetDrag();this._map.flyTo(a,c)},_resetDrag:function(){if(this._dragRectangleG){this._dragRectangleG.remove();this._dragRectangleG=null;this._dragRectangle=null;this._hidePositionMarker()}},_resetView:function(){this._resetDrag();this._hidePositionMarker();this._map.fitBounds(this._fullExtent)},_resizeChart:function(){if(this.options.responsiveView){if(this.options.detachedView){var c=document.querySelector(this.options.elevationDiv);var b=c.offsetWidth;if(b<=0){return}this.options.width=b;c.innerHTML="";var a=this.onAdd(this._map);c.appendChild(a)}else{this._map.removeControl(this._container);this.addTo(this._map)}}},_showDiagramIndicator:function(i,c){var b=this.options;this._focusG.style("visibility","visible");this._mousefocus.attr("x1",c).attr("y1",0).attr("x2",c).attr("y2",this._height()).classed("hidden",false);var d=i.z,e=i.dist,f=i.latlng,j=b.hoverNumber.formatter(d,b.hoverNumber.decimalsY),k=b.hoverNumber.formatter(e,b.hoverNumber.decimalsX);this._focuslabeltext.attr("y",this._y(i.z)).style("font-weight","700");this._focuslabelX.text(k+" "+this._xLabel).attr("x",c+10);this._focuslabelY.text(j+" "+this._yLabel).attr("x",c+10);var a=this._focuslabeltext.node();if(this._isDomVisible(a)){var h=a.getBBox();var g=2;this._focuslabelrect.attr("x",h.x-g).attr("y",h.y-g).attr("width",h.width+(g*2)).attr("height",h.height+(g*2));if(c>=this._width()/2){this._focuslabelrect.attr("x",this._focuslabelrect.attr("x")-this._focuslabelrect.attr("width")-(g*2)-10);this._focuslabelX.attr("x",this._focuslabelX.attr("x")-this._focuslabelrect.attr("width")-(g*2)-10);this._focuslabelY.attr("x",this._focuslabelY.attr("x")-this._focuslabelrect.attr("width")-(g*2)-10)}}},_toggle:function(){if(L.DomUtil.hasClass(this._container,"elevation-expanded")){this._collapse()}else{this._expand()}},_showPositionMarker:function(a){this._selectedItem=a;if(this.options.useLeafletMarker){this._updateLeafletMarker(a)}else{this._updatePositionMarker(a)}},_updateAxis:function(){this._grid.selectAll("g").remove();this._axis.selectAll("g").remove();this._appendXGrid(this._grid);this._appendYGrid(this._grid);this._appendXaxis(this._axis);this._appendYaxis(this._axis)},_updateHeightIndicator:function(f){var e=this.options;var b=e.hoverNumber.formatter(f.z,e.hoverNumber.decimalsY),d=e.hoverNumber.formatter(f.dist,e.hoverNumber.decimalsX);var a=this._height()/this._maxElevation*f.z,c=f.y-a;this._mouseHeightFocus.attr("x1",f.x).attr("x2",f.x).attr("y1",f.y).attr("y2",c).style("visibility","visible");this._mouseHeightFocusLabel.attr("x",f.x).attr("y",c).text(b+" "+this._yLabel).style("visibility","visible")},_updateLeafletMarker:function(a){var b=a.latlng;if(!this._marker){this._marker=new L.Marker(b);this._marker.addTo(this._map)}else{this._marker.setLatLng(b)}},_updatePointG:function(a){this._pointG.attr("transform","translate("+a.x+","+a.y+")").style("visibility","visible")},_updatePositionMarker:function(d){var a=this._map.latLngToLayerPoint(d.latlng);var c={dist:d.dist,x:a.x,y:a.y,z:d.z,};if(!this._mouseHeightFocus){var b=d3.select(this._map.getContainer()).select(".leaflet-overlay-pane svg");this._appendPositionMarker(b)}if(this.options.useMapIndicator){this._updatePointG(c)}if(this.options.useHeightIndicator){this._updateHeightIndicator(c)}},_width:function(){var a=this.options;return a.width-a.margins.left-a.margins.right},});L.control.elevation=function(a){return new L.Control.Elevation(a)};